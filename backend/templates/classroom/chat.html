{% extends 'base_dashboard.html' %}
{% load static %}

{% block page_title %}Chat{% endblock %}

{% block dashboard_content %}
{% csrf_token %}

<!-- Initialize chat data -->
<script>
window.chatData = {
    currentUser: {
        id: {{ user.id }},
        username: "{{ user.username }}",
        firstName: "{{ user.first_name }}",
        lastName: "{{ user.last_name }}",
        email: "{{ user.email }}"
    },
    wsProtocol: window.location.protocol === 'https:' ? 'wss:' : 'ws:',
    wsHost: window.location.host
};
</script>

<!-- Slack-style Chat Interface -->
<div x-data="slackChat()" class="flex h-screen bg-gray-50">
    
    <!-- Left Sidebar - Channels and DMs -->
    <div class="w-80 bg-gray-900 text-white flex flex-col">
        
        <!-- Sidebar Header -->
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold text-white">Chat</h1>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                    <span class="text-sm text-gray-300">Online</span>
                </div>
            </div>
            <div class="text-sm text-gray-400 mt-1">{{ user.first_name }} {{ user.last_name }}</div>
        </div>

        <!-- Channels Section -->
        <div class="flex-1 overflow-y-auto">
            
            <!-- Direct Messages -->
            <div class="p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-gray-300 uppercase tracking-wide">Direct Messages</h3>
                    <button @click="showNewDMModal = true" class="text-gray-400 hover:text-white text-xs">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <!-- Loading State -->
                <div x-show="channelsLoading" class="text-gray-400 text-sm">Loading channels...</div>
                
                <!-- Channels List -->
                <template x-for="channel in channels" :key="channel.id">
                    <div @click="selectChannel(channel)" 
                         :class="{'bg-gray-700': selectedChannel && selectedChannel.id === channel.id}"
                         class="flex items-center p-2 rounded cursor-pointer hover:bg-gray-700 mb-1">
                        
                        <!-- Channel/User Avatar -->
                        <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3"
                             :class="channel.is_direct ? 'bg-blue-600' : 'bg-green-600'">
                            <span class="text-white font-medium text-sm" x-text="getChannelInitials(channel)"></span>
                        </div>
                        
                        <!-- Channel Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <div class="text-white font-medium text-sm truncate" x-text="getChannelName(channel)"></div>
                                <div class="flex items-center space-x-2">
                                    <!-- Online indicator -->
                                    <template x-if="channel.is_direct && isUserOnline(channel)">
                                        <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                    </template>
                                    <!-- Unread count -->
                                    <template x-if="channel.unread_count && channel.unread_count > 0">
                                        <span class="bg-red-600 text-white text-xs px-2 py-1 rounded-full min-w-[20px] text-center" 
                                              x-text="channel.unread_count"></span>
                                    </template>
                                </div>
                            </div>
                            <template x-if="channel.last_message">
                                <div class="text-gray-400 text-xs truncate" x-text="channel.last_message.content"></div>
                            </template>
                        </div>
                    </div>
                </template>
                
                <!-- Empty State -->
                <div x-show="!channelsLoading && channels.length === 0" class="text-gray-400 text-sm text-center py-4">
                    <svg class="w-8 h-8 mx-auto mb-2 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                    </svg>
                    <p>No conversations yet</p>
                    <p class="text-xs mt-1">Start a new conversation</p>
                </div>
            </div>
        </div>

        <!-- User Info at Bottom -->
        <div class="p-4 border-t border-gray-700">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                    <span class="text-white font-medium text-sm">{{ user.first_name.0|upper|default:"A" }}</span>
                </div>
                <div class="flex-1">
                    <div class="text-white font-medium text-sm">{{ user.first_name }} {{ user.last_name }}</div>
                    <div class="text-gray-400 text-xs">{{ user.email }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        
        <!-- Chat Header -->
        <div x-show="selectedChannel" class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <template x-if="selectedChannel">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900" x-text="getChannelName(selectedChannel)"></h2>
                            <div class="flex items-center text-sm text-gray-500 mt-1">
                                <template x-if="selectedChannel.is_direct">
                                    <div class="flex items-center">
                                        <div class="w-2 h-2 rounded-full mr-2" 
                                             :class="isUserOnline(selectedChannel) ? 'bg-green-400' : 'bg-gray-400'"></div>
                                        <span x-text="isUserOnline(selectedChannel) ? 'Online' : 'Offline'"></span>
                                    </div>
                                </template>
                                <template x-if="!selectedChannel.is_direct">
                                    <span x-text="selectedChannel.participants.length + ' members'"></span>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Welcome State (No Channel Selected) -->
        <div x-show="!selectedChannel" class="flex-1 flex items-center justify-center bg-gray-50">
            <div class="text-center">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Welcome to Chat</h3>
                <p class="text-gray-500 mb-4">Select a conversation to start messaging</p>
                <button @click="showNewDMModal = true" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Start New Conversation
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div x-show="selectedChannel" class="flex-1 overflow-y-auto p-6 space-y-4" id="messages-container">
            
            <!-- Loading Messages -->
            <div x-show="messagesLoading" class="text-center text-gray-500">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2">Loading messages...</p>
            </div>

            <!-- Messages -->
            <template x-for="message in messages" :key="message.id">
                <div class="flex items-start space-x-3">
                    <!-- Avatar -->
                    <div class="w-8 h-8 rounded-full flex items-center justify-center"
                         :class="message.sender.username === window.chatData.currentUser.username ? 'bg-blue-600' : 'bg-gray-600'">
                        <span class="text-white font-medium text-sm" x-text="message.sender.username.charAt(0).toUpperCase()"></span>
                    </div>
                    
                    <!-- Message Content -->
                    <div class="flex-1 max-w-3xl">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="font-medium text-gray-900" x-text="message.sender.username"></span>
                            <span class="text-xs text-gray-500" x-text="formatMessageTime(message.timestamp)"></span>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm border">
                            <p class="text-gray-700" x-text="message.content"></p>
                            <!-- File attachment -->
                            <template x-if="message.file">
                                <div class="mt-2">
                                    <a :href="message.file" target="_blank" 
                                       class="text-blue-600 hover:text-blue-800 text-sm underline">
                                        📎 View attachment
                                    </a>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Reactions -->
                        <template x-if="message.reactions && message.reactions.length > 0">
                            <div class="flex space-x-1 mt-2">
                                <template x-for="reaction in message.reactions" :key="reaction.id">
                                    <span class="bg-gray-100 px-2 py-1 rounded-full text-xs cursor-pointer hover:bg-gray-200"
                                          x-text="reaction.emoji + ' ' + reaction.count"></span>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>

        <!-- Message Input -->
        <div x-show="selectedChannel" class="border-t border-gray-200 p-4 bg-white">
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <div class="relative">
                        <input 
                            type="text" 
                            x-model="messageInput"
                            @keydown.enter="sendMessage()"
                            :disabled="!selectedChannel"
                            placeholder="Type your message..." 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>
                </div>
                <button 
                    @click="sendMessage()"
                    :disabled="!selectedChannel || !messageInput.trim()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium">
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- New DM Modal -->
    <div x-show="showNewDMModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4"
             @click.away="showNewDMModal = false">
            <h3 class="text-lg font-semibold mb-4">Start New Conversation</h3>
            
            <!-- User Search -->
            <div class="mb-4">
                <input 
                    type="text"
                    x-model="userSearchQuery"
                    @input="searchUsers()"
                    placeholder="Search users by name or email..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>

            <!-- Search Results -->
            <div class="max-h-60 overflow-y-auto mb-4">
                <template x-if="userSearchLoading">
                    <div class="text-center py-4 text-gray-500">Searching...</div>
                </template>
                
                <template x-for="user in searchResults" :key="user.id">
                    <div @click="startDMWithUser(user)"
                         class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                            <span class="text-white font-medium text-sm" x-text="user.first_name.charAt(0).toUpperCase()"></span>
                        </div>
                        <div>
                            <div class="font-medium" x-text="user.first_name + ' ' + user.last_name"></div>
                            <div class="text-sm text-gray-500" x-text="user.email"></div>
                        </div>
                    </div>
                </template>
                
                <template x-if="!userSearchLoading && searchResults.length === 0 && userSearchQuery">
                    <div class="text-center py-4 text-gray-500">No users found</div>
                </template>
            </div>

            <!-- Modal Actions -->
            <div class="flex justify-end space-x-3">
                <button @click="showNewDMModal = false" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function slackChat() {
    return {
        // State
        channels: [],
        selectedChannel: null,
        messages: [],
        messageInput: '',
        channelsLoading: true,
        messagesLoading: false,
        showNewDMModal: false,
        userSearchQuery: '',
        userSearchLoading: false,
        searchResults: [],
        
        // WebSocket
        websocket: null,

        async init() {
            await this.loadChannels();
            this.initWebSocket();
        },

        initWebSocket() {
            // Initialize WebSocket connection for general notifications
            // Individual channel WebSockets are handled in connectToChannelWebSocket
            console.log('WebSocket initialization ready');
        },

        async loadChannels() {
            this.channelsLoading = true;
            try {
                const response = await fetch('/api/classroom/chat/channels/', {
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.channels = data.channels || [];
                }
            } catch (error) {
                console.error('Failed to load channels:', error);
            } finally {
                this.channelsLoading = false;
            }
        },

        async selectChannel(channel) {
            this.selectedChannel = channel;
            await this.loadMessages(channel.id);
            this.connectToChannelWebSocket(channel);
        },

        async loadMessages(channelId) {
            this.messagesLoading = true;
            try {
                const response = await fetch(`/api/classroom/chat/channels/${channelId}/messages/`, {
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.messages = data.messages || []; // Messages are already in correct order
                    this.$nextTick(() => {
                        this.scrollToBottom();
                    });
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            } finally {
                this.messagesLoading = false;
            }
        },

        connectToChannelWebSocket(channel) {
            if (this.websocket) {
                this.websocket.close();
            }

            const wsUrl = `${window.chatData.wsProtocol}//${window.chatData.wsHost}/ws/chat/${channel.name}/`;
            this.websocket = new WebSocket(wsUrl);

            this.websocket.onopen = () => {
                console.log('WebSocket connected to channel:', channel.name);
            };

            this.websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.handleWebSocketMessage(data);
            };

            this.websocket.onclose = () => {
                console.log('WebSocket disconnected');
            };

            this.websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        },

        handleWebSocketMessage(data) {
            if (data.type === 'chat_message') {
                this.messages.push(data.message);
                this.$nextTick(() => {
                    this.scrollToBottom();
                });
            } else if (data.type === 'user_status') {
                this.handleUserStatusUpdate(data);
            }
        },

        async sendMessage() {
            if (!this.messageInput.trim() || !this.selectedChannel) return;

            try {
                const response = await fetch(`/api/classroom/chat/channels/${this.selectedChannel.id}/messages/`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify({
                        content: this.messageInput
                    })
                });

                if (response.ok) {
                    this.messageInput = '';
                }
            } catch (error) {
                console.error('Failed to send message:', error);
            }
        },

        async searchUsers() {
            if (!this.userSearchQuery.trim()) {
                this.searchResults = [];
                return;
            }

            this.userSearchLoading = true;
            try {
                const response = await fetch(`/api/classroom/chat/users/search/?search=${encodeURIComponent(this.userSearchQuery)}`, {
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.searchResults = data.users || [];
                }
            } catch (error) {
                console.error('Failed to search users:', error);
            } finally {
                this.userSearchLoading = false;
            }
        },

        async startDMWithUser(user) {
            try {
                const response = await fetch('/api/classroom/chat/channels/', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify({
                        is_direct: true,
                        participant_ids: [user.id]
                    })
                });

                if (response.ok) {
                    const channel = await response.json();
                    this.channels.unshift(channel);
                    this.selectChannel(channel);
                    this.showNewDMModal = false;
                    this.userSearchQuery = '';
                    this.searchResults = [];
                }
            } catch (error) {
                console.error('Failed to create DM:', error);
            }
        },

        // Helper methods
        getChannelName(channel) {
            if (!channel) return '';
            
            if (channel.is_direct) {
                // For DMs, show the other participant's name
                const otherUser = channel.participants?.find(p => p.username !== window.chatData.currentUser.username);
                return otherUser ? `${otherUser.first_name} ${otherUser.last_name}` : 'Direct Message';
            }
            return channel.name || 'Group Chat';
        },

        getChannelInitials(channel) {
            if (!channel) return 'C';
            
            if (channel.is_direct) {
                const otherUser = channel.participants?.find(p => p.username !== window.chatData.currentUser.username);
                return otherUser ? otherUser.first_name.charAt(0).toUpperCase() : 'D';
            }
            return channel.name ? channel.name.charAt(0).toUpperCase() : 'G';
        },

        isUserOnline(channel) {
            if (!channel.is_direct || !channel.online) return false;
            return channel.online.some(user => user.username !== window.chatData.currentUser.username);
        },

        formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            
            if (isToday) {
                return date.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('pt-PT', { month: 'short', day: 'numeric' }) + ' ' +
                       date.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
            }
        },

        scrollToBottom() {
            const container = document.getElementById('messages-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Slack-style chat interface loaded');
});
</script>
{% endblock %}