================================================================================
STRIPE WEBHOOK EVENT PROCESSING VALIDATION
================================================================================

Test ID: WEBHOOK-002
Test Name: Stripe Webhook Event Processing (Payment Success/Failure/Cancellation)
Test Type: Functional/Integration
Priority: Critical
Estimated Time: 35 minutes

================================================================================
TEST PURPOSE
================================================================================

Validate that the Stripe webhook handler correctly processes all supported event types:
âœ… payment_intent.succeeded: Credit hours and update transaction to COMPLETED
âœ… payment_intent.payment_failed: Update transaction to FAILED with error details
âœ… payment_intent.canceled: Update transaction to FAILED with cancellation reason
âœ… Proper integration with PaymentService for transaction updates
âœ… Accurate hour crediting for successful payments
âœ… Database consistency across all event processing scenarios

This test ensures the webhook correctly handles the complete payment lifecycle
and maintains data integrity for all transaction states.

================================================================================
PREREQUISITES
================================================================================

âœ… Virtual environment configured (.venv directory exists)
âœ… Dependencies installed (backend/requirements.txt)
âœ… Stripe CLI installed and configured for webhook testing
âœ… Test database with clean state
âœ… STRIPE_WEBHOOK_SECRET configured for signature verification

================================================================================
TEST PROCEDURE
================================================================================

Step 1: Environment Setup and Service Start
===========================================
Commands:
  cd /Users/anapmc/Code/aprendecomigo
  source .venv/bin/activate
  make dev

Expected:
âœ… Django development server starts on port 8000
âœ… Backend accessible at http://localhost:8000/api/
âœ… Webhook endpoint available at /api/finances/webhooks/stripe/

Screenshot: 01-servers-started.png
Duration: ~15 seconds

Step 2: Create Test Transaction Data
====================================
Commands:
  cd backend
  python manage.py test_stripe_webhook --create-test-data --payment-intent-id pi_test_success_001

Expected:
âœ… Test student created: webhook.test@aprendecomigo.com
âœ… Test transaction created with payment intent: pi_test_success_001
âœ… Transaction status: PROCESSING
âœ… Transaction amount: â‚¬50.00 with 10.00 hours metadata
âœ… Student account balance initialized with 0.00 hours

Screenshot: 02-test-transaction-created.png

Step 3: Verify Initial Database State
=====================================
Commands:
  # Check transaction status before webhook processing
  python manage.py shell -c "
from finances.models import PurchaseTransaction, StudentAccountBalance
from accounts.models import CustomUser

student = CustomUser.objects.get(email='webhook.test@aprendecomigo.com')
transaction = PurchaseTransaction.objects.get(stripe_payment_intent_id='pi_test_success_001')
balance = StudentAccountBalance.objects.get(student=student)

print(f'Transaction Status: {transaction.payment_status}')
print(f'Transaction Amount: â‚¬{transaction.amount}')
print(f'Hours in Metadata: {transaction.metadata.get(\"hours\", \"N/A\")}')
print(f'Student Hours Balance: {balance.hours_purchased}')
print(f'Student Amount Balance: â‚¬{balance.balance_amount}')
"

Expected:
âœ… Transaction status: PROCESSING
âœ… Transaction amount: 50.00
âœ… Hours in metadata: 10.00
âœ… Student hours balance: 0.00
âœ… Student amount balance: 0.00

Screenshot: 03-initial-database-state.png

Step 4: Test Payment Success Event Processing
==============================================
Commands:
  # Simulate payment_intent.succeeded webhook event
  stripe trigger payment_intent.succeeded --override payment_intent:id=pi_test_success_001

Expected:
âœ… Stripe CLI sends payment_intent.succeeded event to webhook
âœ… Webhook receives event with valid signature
âœ… Event type recognized as supported
âœ… PaymentService.confirm_payment_completion called
âœ… HTTP 200 response returned to Stripe

Screenshot: 04-payment-success-event-sent.png

Step 5: Verify Payment Success Processing Results
=================================================
Commands:
  # Check database state after successful payment processing
  python manage.py shell -c "
from finances.models import PurchaseTransaction, StudentAccountBalance
from accounts.models import CustomUser

student = CustomUser.objects.get(email='webhook.test@aprendecomigo.com')
transaction = PurchaseTransaction.objects.get(stripe_payment_intent_id='pi_test_success_001')
balance = StudentAccountBalance.objects.get(student=student)

print(f'Transaction Status: {transaction.payment_status}')
print(f'Transaction Completed At: {transaction.completed_at}')
print(f'Student Hours Balance: {balance.hours_purchased}')
print(f'Student Amount Balance: â‚¬{balance.balance_amount}')
print(f'Hours Consumed: {balance.hours_consumed}')
"

Expected:
âœ… Transaction status changed to: COMPLETED
âœ… Transaction completed_at timestamp set
âœ… Student hours balance increased to: 10.00 (credited)
âœ… Student amount balance increased to: 50.00 (credited)
âœ… Hours consumed remains: 0.00

Screenshot: 05-payment-success-results.png

Step 6: Create Test Transaction for Payment Failure
====================================================
Commands:
  python manage.py test_stripe_webhook --create-test-data --payment-intent-id pi_test_failure_002

Expected:
âœ… Second test transaction created with payment intent: pi_test_failure_002
âœ… Transaction status: PROCESSING
âœ… Separate transaction record in database
âœ… Ready for failure scenario testing

Screenshot: 06-failure-test-transaction-created.png

Step 7: Test Payment Failure Event Processing
==============================================
Commands:
  # Simulate payment_intent.payment_failed webhook event
  stripe trigger payment_intent.payment_failed --override payment_intent:id=pi_test_failure_002

Expected:
âœ… Stripe CLI sends payment_intent.payment_failed event to webhook
âœ… Webhook receives event with valid signature  
âœ… Event type recognized as supported
âœ… PaymentService.handle_payment_failure called
âœ… HTTP 200 response returned to Stripe

Screenshot: 07-payment-failure-event-sent.png

Step 8: Verify Payment Failure Processing Results
==================================================
Commands:
  # Check database state after failed payment processing
  python manage.py shell -c "
from finances.models import PurchaseTransaction
transaction = PurchaseTransaction.objects.get(stripe_payment_intent_id='pi_test_failure_002')

print(f'Transaction Status: {transaction.payment_status}')
print(f'Error Message in Metadata: {transaction.metadata.get(\"error_message\", \"N/A\")}')
print(f'Failed At: {transaction.metadata.get(\"failed_at\", \"N/A\")}')
"

Expected:
âœ… Transaction status changed to: FAILED
âœ… Error message stored in metadata (e.g., "Your card was declined")
âœ… Failed timestamp recorded in metadata
âœ… No hours or amount credited to student account

Screenshot: 08-payment-failure-results.png

Step 9: Create Test Transaction for Payment Cancellation
=========================================================
Commands:
  python manage.py test_stripe_webhook --create-test-data --payment-intent-id pi_test_canceled_003

Expected:
âœ… Third test transaction created with payment intent: pi_test_canceled_003
âœ… Transaction status: PROCESSING
âœ… Ready for cancellation scenario testing

Screenshot: 09-cancellation-test-transaction-created.png

Step 10: Test Payment Cancellation Event Processing
====================================================
Commands:
  # Simulate payment_intent.canceled webhook event
  stripe trigger payment_intent.canceled --override payment_intent:id=pi_test_canceled_003

Expected:
âœ… Stripe CLI sends payment_intent.canceled event to webhook
âœ… Webhook receives event with valid signature
âœ… Event type recognized as supported
âœ… PaymentService.handle_payment_failure called with cancellation reason
âœ… HTTP 200 response returned to Stripe

Screenshot: 10-payment-cancellation-event-sent.png

Step 11: Verify Payment Cancellation Processing Results
========================================================
Commands:
  # Check database state after canceled payment processing
  python manage.py shell -c "
from finances.models import PurchaseTransaction
transaction = PurchaseTransaction.objects.get(stripe_payment_intent_id='pi_test_canceled_003')

print(f'Transaction Status: {transaction.payment_status}')
print(f'Error Message in Metadata: {transaction.metadata.get(\"error_message\", \"N/A\")}')
print(f'Cancellation Reason: {transaction.metadata.get(\"cancellation_reason\", \"N/A\")}')
"

Expected:
âœ… Transaction status changed to: FAILED
âœ… Error message: "Payment was canceled"
âœ… Cancellation reason stored in metadata
âœ… No hours or amount credited to student account

Screenshot: 11-payment-cancellation-results.png

Step 12: Test Unsupported Event Type Handling
==============================================
Commands:
  # Test webhook response to unsupported event type
  stripe trigger customer.created

Expected:
âœ… Stripe CLI sends customer.created event to webhook
âœ… Webhook receives event with valid signature
âœ… Event type identified as unsupported
âœ… HTTP 200 response with "Event type not supported" message
âœ… No database changes or processing attempted

Screenshot: 12-unsupported-event-handling.png

Step 13: Verify Comprehensive Event Logging
============================================
Commands:
  make logs | grep -i webhook | tail -20

Expected:
âœ… All webhook events logged with event type and ID
âœ… Successful processing logged with INFO level
âœ… Payment completion events logged with transaction details
âœ… Payment failure events logged with error information
âœ… Unsupported events logged with appropriate messages

Screenshot: 13-comprehensive-event-logging.png

Step 14: Verify Database Consistency Across All Scenarios
==========================================================
Commands:
  # Final database state verification
  python manage.py shell -c "
from finances.models import PurchaseTransaction, StudentAccountBalance
from accounts.models import CustomUser

student = CustomUser.objects.get(email='webhook.test@aprendecomigo.com')
transactions = PurchaseTransaction.objects.filter(student=student).order_by('created_at')
balance = StudentAccountBalance.objects.get(student=student)

print('=== FINAL DATABASE STATE ===')
print(f'Total Transactions: {transactions.count()}')
for t in transactions:
    print(f'  {t.stripe_payment_intent_id}: {t.payment_status} - â‚¬{t.amount}')

print(f'Student Final Hours Balance: {balance.hours_purchased}')
print(f'Student Final Amount Balance: â‚¬{balance.balance_amount}')
print(f'Hours Consumed: {balance.hours_consumed}')
"

Expected:
âœ… 3 total transactions processed
âœ… pi_test_success_001: COMPLETED status
âœ… pi_test_failure_002: FAILED status  
âœ… pi_test_canceled_003: FAILED status
âœ… Student final hours balance: 10.00 (only from successful payment)
âœ… Student final amount balance: 50.00 (only from successful payment)

Screenshot: 14-final-database-consistency.png

================================================================================
CLEANUP
================================================================================

Commands:
  make stop

Expected:
âœ… All server processes terminated cleanly
âœ… Test data remains in database for further analysis if needed
âœ… Stripe CLI webhook forwarding stopped

================================================================================
PASS/FAIL CRITERIA
================================================================================

âœ… PASS: All event types correctly processed with appropriate database updates
âœ… PASS: Payment success properly credits hours and updates transaction status
âœ… PASS: Payment failures properly update status with error information
âœ… PASS: Payment cancellations handled correctly with proper error messaging
âœ… PASS: Unsupported events handled gracefully without errors
âœ… PASS: Database consistency maintained across all scenarios
âœ… PASS: Comprehensive logging provides audit trail for all events

âŒ FAIL: Any event type not processed correctly
âŒ FAIL: Hours not credited properly for successful payments
âŒ FAIL: Transaction statuses not updated appropriately
âŒ FAIL: Database inconsistencies or data corruption
âŒ FAIL: Missing or incomplete error information for failures
âŒ FAIL: Server errors or crashes during event processing

================================================================================
BUSINESS IMPACT
================================================================================

ğŸ’° This test validates the core payment processing workflow for the platform
ğŸ’° Accurate hour crediting directly impacts service delivery to students
ğŸ’° Proper failure handling prevents revenue loss and customer confusion
ğŸ’° Database consistency ensures reliable billing and account management
ğŸ’° Event processing reliability affects customer trust and platform reputation

Any failures in this test case indicate critical issues that could result in
financial discrepancies, service disruption, or customer dissatisfaction.