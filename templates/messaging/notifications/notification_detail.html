{% extends "base_with_navs.html" %}
{% load static %}

{% block title %}Notification Details{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <div>
                    <a href="{% url 'messaging:notification-list' %}"
                       class="text-gray-400 hover:text-gray-500">
                        <span class="sr-only">Notifications</span>
                        Notifications
                    </a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="flex-shrink-0 h-5 w-5 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
                    </svg>
                    <span class="ml-4 text-sm font-medium text-gray-500" aria-current="page">
                        Details
                    </span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Notification Details Card -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <!-- Header -->
            <div class="flex items-start justify-between mb-6">
                <div class="flex-1">
                    <!-- Status Badges -->
                    <div class="flex items-center space-x-2 mb-3">
                        {% if notification.notification_type == 'low_balance' %}
                            <span class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                ‚ö†Ô∏è Low Balance
                            </span>
                        {% elif notification.notification_type == 'package_expiring' %}
                            <span class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
                                ‚è∞ Package Expiring
                            </span>
                        {% elif notification.notification_type == 'balance_depleted' %}
                            <span class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                üö´ Balance Depleted
                            </span>
                        {% endif %}

                        {% if notification.is_read %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                ‚úì Read
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ‚Ä¢ Unread
                            </span>
                        {% endif %}
                    </div>

                    <!-- Title -->
                    <h1 class="text-xl font-semibold text-gray-900 mb-2">
                        {{ notification.title }}
                    </h1>

                    <!-- Timestamp -->
                    <p class="text-sm text-gray-500">
                        Created {{ notification.created_at|timesince }} ago
                        {% if notification.read_at %}
                            ‚Ä¢ Read {{ notification.read_at|timesince }} ago
                        {% endif %}
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center space-x-3">
                    {% if not notification.is_read %}
                        <button hx-post="{% url 'messaging:notification-mark-read' notification.pk %}"
                                hx-target="#notification-status"
                                hx-swap="innerHTML"
                                class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Mark as Read
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Message Content -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-sm font-medium text-gray-900 mb-3">Message</h3>
                <div class="prose prose-sm max-w-none text-gray-600">
                    {{ notification.message|linebreaks }}
                </div>
            </div>

            <!-- Related Transaction (if applicable) -->
            {% if notification.related_transaction %}
                <div class="border-t border-gray-200 pt-6 mt-6">
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Related Transaction</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Transaction ID</dt>
                                <dd class="text-sm text-gray-900">#{{ notification.related_transaction.id }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Status</dt>
                                <dd class="text-sm text-gray-900">{{ notification.related_transaction.get_status_display }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Amount</dt>
                                <dd class="text-sm text-gray-900">
                                    ‚Ç¨{{ notification.related_transaction.amount_eur|floatformat:2 }}
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Created</dt>
                                <dd class="text-sm text-gray-900">
                                    {{ notification.related_transaction.created_at|date:"M j, Y g:i A" }}
                                </dd>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Metadata -->
            {% if notification.metadata %}
                <div class="border-t border-gray-200 pt-6 mt-6">
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Additional Information</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <pre class="text-sm text-gray-600 whitespace-pre-wrap">{{ notification.metadata|pprint }}</pre>
                    </div>
                </div>
            {% endif %}

            <!-- Status Update Area -->
            <div id="notification-status" class="hidden">
                <!-- Updated content will be inserted here via HTMX -->
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-4 py-4 sm:px-6 rounded-b-lg">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-500">
                    Last updated: {{ notification.updated_at|date:"M j, Y g:i A" }}
                </div>
                <div class="flex items-center space-x-3">
                    <a href="{% url 'messaging:notification-list' %}"
                       class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Back to Notifications
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Show success message after marking as read
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'notification-status') {
            // Show success message
            const statusDiv = document.getElementById('notification-status');
            statusDiv.innerHTML = `
                <div class="border-t border-gray-200 pt-6 mt-6">
                    <div class="rounded-md bg-green-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-green-800">
                                    Notification marked as read successfully!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            statusDiv.classList.remove('hidden');

            // Hide the success message after 3 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }
    });
</script>
{% endblock %}
