{% load i18n %}

<form 
    hx-post="{% if edit_mode and schedule %}{% url 'scheduler:schedules-detail' schedule.id %}{% else %}{% url 'scheduler:schedules-list' %}{% endif %}"
    hx-vals='{"action": "{% if edit_mode %}update_schedule{% else %}create_schedule{% endif %}"}'
    hx-target="{% if edit_mode %}#schedule-form-response{% else %}#schedule-content{% endif %}"
    hx-swap="{% if edit_mode %}innerHTML{% else %}afterbegin{% endif %}"
    class="space-y-4">
    
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        
        <!-- Title -->
        <div class="sm:col-span-2">
            <label for="title" class="block text-sm font-medium text-gray-700">
                {% trans "Class Title" %} <span class="text-red-500">*</span>
            </label>
            <input 
                type="text" 
                name="title" 
                id="title" 
                required
                value="{{ schedule.title|default:'' }}"
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="{% trans 'Enter class title...' %}">
        </div>

        <!-- Description -->
        <div class="sm:col-span-2">
            <label for="description" class="block text-sm font-medium text-gray-700">
                {% trans "Description" %}
            </label>
            <textarea 
                name="description" 
                id="description" 
                rows="3"
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="{% trans 'Enter class description...' %}">{{ schedule.description|default:'' }}</textarea>
        </div>

        <!-- Teacher Selection -->
        <div>
            <label for="teacher" class="block text-sm font-medium text-gray-700">
                {% trans "Teacher" %} <span class="text-red-500">*</span>
            </label>
            <select 
                name="teacher" 
                id="teacher"
                required
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="">{% trans "Select a teacher..." %}</option>
                {% for teacher in available_teachers %}
                <option value="{{ teacher.id }}" {% if schedule.teacher_id == teacher.id %}selected{% endif %}>
                    {{ teacher.user.name }} ({{ teacher.user.email }})
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- School Selection -->
        <div>
            <label for="school" class="block text-sm font-medium text-gray-700">
                {% trans "School" %} <span class="text-red-500">*</span>
            </label>
            <select 
                name="school" 
                id="school"
                required
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="">{% trans "Select a school..." %}</option>
                {% for school in user_schools %}
                <option value="{{ school.id }}" {% if schedule.school_id == school.id %}selected{% endif %}>
                    {{ school.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Student Selection (Admin Only) -->
        {% if user_is_admin %}
        <div>
            <label for="student" class="block text-sm font-medium text-gray-700">
                {% trans "Main Student" %}
            </label>
            <select 
                name="student" 
                id="student"
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="">{% trans "Select main student..." %}</option>
                {% for student in available_students %}
                <option value="{{ student.id }}" {% if schedule.student_id == student.id %}selected{% endif %}>
                    {{ student.name }} ({{ student.email }})
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Additional Students -->
        <div>
            <label for="additional_students" class="block text-sm font-medium text-gray-700">
                {% trans "Additional Students" %}
            </label>
            <select 
                name="additional_students" 
                id="additional_students"
                multiple
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                {% for student in available_students %}
                <option value="{{ student.id }}" {% if student in schedule.additional_students.all %}selected{% endif %}>
                    {{ student.name }} ({{ student.email }})
                </option>
                {% endfor %}
            </select>
            <p class="mt-1 text-xs text-gray-500">{% trans "Hold Ctrl/Cmd to select multiple students" %}</p>
        </div>
        {% endif %}

        <!-- Date -->
        <div>
            <label for="scheduled_date" class="block text-sm font-medium text-gray-700">
                {% trans "Date" %} <span class="text-red-500">*</span>
            </label>
            <input 
                type="date" 
                name="scheduled_date" 
                id="scheduled_date"
                required
                value="{% if schedule.scheduled_date %}{{ schedule.scheduled_date|date:'Y-m-d' }}{% endif %}"
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>

        <!-- Start Time -->
        <div>
            <label for="start_time" class="block text-sm font-medium text-gray-700">
                {% trans "Start Time" %} <span class="text-red-500">*</span>
            </label>
            <input 
                type="time" 
                name="start_time" 
                id="start_time"
                required
                value="{% if schedule.start_time %}{{ schedule.start_time|time:'H:i' }}{% endif %}"
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>

        <!-- End Time -->
        <div>
            <label for="end_time" class="block text-sm font-medium text-gray-700">
                {% trans "End Time" %} <span class="text-red-500">*</span>
            </label>
            <input 
                type="time" 
                name="end_time" 
                id="end_time"
                required
                value="{% if schedule.end_time %}{{ schedule.end_time|time:'H:i' }}{% endif %}"
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>

        {% if edit_mode and schedule %}
        <!-- Status (only in edit mode) -->
        <div>
            <label for="status" class="block text-sm font-medium text-gray-700">
                {% trans "Status" %}
            </label>
            <select 
                name="status" 
                id="status"
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="scheduled" {% if schedule.status == 'scheduled' %}selected{% endif %}>{% trans "Scheduled" %}</option>
                <option value="confirmed" {% if schedule.status == 'confirmed' %}selected{% endif %}>{% trans "Confirmed" %}</option>
                <option value="completed" {% if schedule.status == 'completed' %}selected{% endif %}>{% trans "Completed" %}</option>
                <option value="cancelled" {% if schedule.status == 'cancelled' %}selected{% endif %}>{% trans "Cancelled" %}</option>
                <option value="no_show" {% if schedule.status == 'no_show' %}selected{% endif %}>{% trans "No Show" %}</option>
            </select>
        </div>

        <!-- Notes (only in edit mode) -->
        <div>
            <label for="notes" class="block text-sm font-medium text-gray-700">
                {% trans "Notes" %}
            </label>
            <textarea 
                name="notes" 
                id="notes" 
                rows="2"
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="{% trans 'Add any notes...' %}">{{ schedule.notes|default:'' }}</textarea>
        </div>
        {% endif %}

    </div>

    <!-- Form Actions -->
    <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
        {% if not edit_mode %}
        <button 
            type="button"
            @click="showForm = false"
            class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            {% trans "Cancel" %}
        </button>
        {% endif %}
        
        <button 
            type="submit"
            class="px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            {% if edit_mode %}
                {% trans "Update Class" %}
            {% else %}
                {% trans "Book Class" %}
            {% endif %}
        </button>
    </div>

    {% if edit_mode %}
    <!-- Response area for edit form -->
    <div id="schedule-form-response"></div>
    {% endif %}

</form>

<script>
    // Auto-calculate end time based on start time (default 1 hour)
    document.getElementById('start_time').addEventListener('change', function() {
        const startTime = this.value;
        const endTimeField = document.getElementById('end_time');
        
        if (startTime && !endTimeField.value) {
            const [hours, minutes] = startTime.split(':');
            const startDate = new Date();
            startDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            // Add 1 hour
            startDate.setHours(startDate.getHours() + 1);
            
            const endTime = startDate.toTimeString().slice(0, 5);
            endTimeField.value = endTime;
        }
    });

    // Load available teachers when school changes
    document.getElementById('school').addEventListener('change', function() {
        const schoolId = this.value;
        if (schoolId) {
            htmx.ajax('GET', `/scheduler/availability/?school_id=${schoolId}`, {
                target: '#teacher',
                swap: 'innerHTML',
                values: { 'load_teachers': true }
            });
        }
    });
</script>