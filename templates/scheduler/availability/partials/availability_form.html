{% load i18n %}

<form 
    hx-post="{% if edit_mode and availability %}{% url 'scheduler:availability-detail' availability.id %}{% else %}{% url 'scheduler:availability-list' %}{% endif %}"
    hx-vals='{"action": "{% if edit_mode %}update_availability{% else %}create_availability{% endif %}"}'
    hx-target="{% if edit_mode %}#availability-form-response{% else %}#availability-list{% endif %}"
    hx-swap="{% if edit_mode %}innerHTML{% else %}afterbegin{% endif %}"
    class="space-y-4">
    
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        
        <!-- Teacher Selection (Admin only) -->
        {% if user_is_admin %}
        <div>
            <label for="teacher" class="block text-sm font-medium text-gray-700">
                {% trans "Teacher" %} <span class="text-red-500">*</span>
            </label>
            <select 
                name="teacher" 
                id="teacher"
                required
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="">{% trans "Select a teacher..." %}</option>
                {% for teacher in available_teachers %}
                <option value="{{ teacher.id }}" {% if availability.teacher_id == teacher.id %}selected{% endif %}>
                    {{ teacher.user.name }} ({{ teacher.user.email }})
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <!-- School Selection -->
        <div>
            <label for="school" class="block text-sm font-medium text-gray-700">
                {% trans "School" %} <span class="text-red-500">*</span>
            </label>
            <select 
                name="school" 
                id="school"
                required
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="">{% trans "Select a school..." %}</option>
                {% for school in user_schools %}
                <option value="{{ school.id }}" {% if availability.school_id == school.id %}selected{% endif %}>
                    {{ school.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Day of Week -->
        <div>
            <label for="day_of_week" class="block text-sm font-medium text-gray-700">
                {% trans "Day of Week" %} <span class="text-red-500">*</span>
            </label>
            <select 
                name="day_of_week" 
                id="day_of_week"
                required
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="">{% trans "Select day..." %}</option>
                <option value="0" {% if availability.day_of_week == 0 %}selected{% endif %}>{% trans "Monday" %}</option>
                <option value="1" {% if availability.day_of_week == 1 %}selected{% endif %}>{% trans "Tuesday" %}</option>
                <option value="2" {% if availability.day_of_week == 2 %}selected{% endif %}>{% trans "Wednesday" %}</option>
                <option value="3" {% if availability.day_of_week == 3 %}selected{% endif %}>{% trans "Thursday" %}</option>
                <option value="4" {% if availability.day_of_week == 4 %}selected{% endif %}>{% trans "Friday" %}</option>
                <option value="5" {% if availability.day_of_week == 5 %}selected{% endif %}>{% trans "Saturday" %}</option>
                <option value="6" {% if availability.day_of_week == 6 %}selected{% endif %}>{% trans "Sunday" %}</option>
            </select>
        </div>

        <!-- Start Time -->
        <div>
            <label for="start_time" class="block text-sm font-medium text-gray-700">
                {% trans "Start Time" %} <span class="text-red-500">*</span>
            </label>
            <input 
                type="time" 
                name="start_time" 
                id="start_time"
                required
                value="{% if availability.start_time %}{{ availability.start_time|time:'H:i' }}{% endif %}"
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>

        <!-- End Time -->
        <div>
            <label for="end_time" class="block text-sm font-medium text-gray-700">
                {% trans "End Time" %} <span class="text-red-500">*</span>
            </label>
            <input 
                type="time" 
                name="end_time" 
                id="end_time"
                required
                value="{% if availability.end_time %}{{ availability.end_time|time:'H:i' }}{% endif %}"
                class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>

        <!-- Active Status -->
        <div class="flex items-center">
            <input 
                type="checkbox" 
                name="is_active" 
                id="is_active"
                {% if not availability or availability.is_active %}checked{% endif %}
                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <label for="is_active" class="ml-2 block text-sm text-gray-700">
                {% trans "Active" %}
            </label>
        </div>

    </div>

    <!-- Form Actions -->
    <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
        {% if not edit_mode %}
        <button 
            type="button"
            @click="showForm = false"
            class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            {% trans "Cancel" %}
        </button>
        {% endif %}
        
        <button 
            type="submit"
            class="px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            {% if edit_mode %}
                {% trans "Update Availability" %}
            {% else %}
                {% trans "Add Availability" %}
            {% endif %}
        </button>
    </div>

    {% if edit_mode %}
    <!-- Response area for edit form -->
    <div id="availability-form-response"></div>
    {% endif %}

</form>

<script>
    // Validation: End time should be after start time
    document.getElementById('end_time').addEventListener('change', function() {
        const startTime = document.getElementById('start_time').value;
        const endTime = this.value;
        
        if (startTime && endTime && startTime >= endTime) {
            alert('{% trans "End time must be after start time" %}');
            this.value = '';
        }
    });

    document.getElementById('start_time').addEventListener('change', function() {
        const startTime = this.value;
        const endTime = document.getElementById('end_time').value;
        
        if (startTime && endTime && startTime >= endTime) {
            // Auto-adjust end time to be 1 hour after start time
            const [hours, minutes] = startTime.split(':');
            const startDate = new Date();
            startDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            startDate.setHours(startDate.getHours() + 1);
            
            const newEndTime = startDate.toTimeString().slice(0, 5);
            document.getElementById('end_time').value = newEndTime;
        }
    });
</script>