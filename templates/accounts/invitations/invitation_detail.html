{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Invitation Details - {{ invitation.email }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="max-w-4xl mx-auto">
        <div class="mb-6">
            <div class="flex items-center">
                <a href="{% url 'accounts:invitation_list' %}" 
                   class="text-gray-500 hover:text-gray-700 mr-4">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-3xl font-bold text-gray-900">Invitation Details</h1>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Teacher Invitation</h2>
            </div>
            <div class="px-6 py-4">
                <!-- Status Banner -->
                <div class="mb-6 p-4 rounded-lg
                    {% if invitation.status == 'accepted' %}bg-green-50 border border-green-200
                    {% elif invitation.status == 'pending' %}bg-yellow-50 border border-yellow-200
                    {% elif invitation.status == 'sent' %}bg-blue-50 border border-blue-200
                    {% elif invitation.status == 'declined' %}bg-red-50 border border-red-200
                    {% else %}bg-gray-50 border border-gray-200{% endif %}">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle 
                            {% if invitation.status == 'accepted' %}text-green-500
                            {% elif invitation.status == 'pending' %}text-yellow-500
                            {% elif invitation.status == 'sent' %}text-blue-500
                            {% elif invitation.status == 'declined' %}text-red-500
                            {% else %}text-gray-500{% endif %} mr-3"></i>
                        <div>
                            <h3 class="text-lg font-medium 
                                {% if invitation.status == 'accepted' %}text-green-900
                                {% elif invitation.status == 'pending' %}text-yellow-900
                                {% elif invitation.status == 'sent' %}text-blue-900
                                {% elif invitation.status == 'declined' %}text-red-900
                                {% else %}text-gray-900{% endif %}">
                                Status: {{ invitation.get_status_display }}
                            </h3>
                            <p class="text-sm 
                                {% if invitation.status == 'accepted' %}text-green-700
                                {% elif invitation.status == 'pending' %}text-yellow-700
                                {% elif invitation.status == 'sent' %}text-blue-700
                                {% elif invitation.status == 'declined' %}text-red-700
                                {% else %}text-gray-700{% endif %}">
                                {% if invitation.is_expired %}
                                    This invitation has expired and is no longer valid.
                                {% elif invitation.status == 'accepted' %}
                                    The teacher has accepted this invitation and joined the school.
                                {% elif invitation.status == 'declined' %}
                                    The teacher has declined this invitation.
                                {% elif invitation.status == 'pending' %}
                                    This invitation is waiting to be sent.
                                {% elif invitation.status == 'sent' %}
                                    The invitation email has been sent and is pending response.
                                {% else %}
                                    This invitation is currently {{ invitation.get_status_display|lower }}.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Invitation Details -->
                <div class="space-y-6">
                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Invited Teacher</h4>
                            <p class="mt-1 text-sm text-gray-900">{{ invitation.email }}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-500">School</h4>
                            <p class="mt-1 text-sm text-gray-900">{{ invitation.school.name }}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Role</h4>
                            <p class="mt-1 text-sm text-gray-900">{{ invitation.get_role_display }}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Invited By</h4>
                            <p class="mt-1 text-sm text-gray-900">{{ invitation.invited_by.get_full_name|default:invitation.invited_by.email }}</p>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="pt-6 border-t border-gray-200">
                        <h4 class="text-sm font-medium text-gray-500 mb-4">Timeline</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Created:</span>
                                <span class="text-sm text-gray-900">{{ invitation.created_at|date:"F j, Y \a\t g:i A" }}</span>
                            </div>
                            {% if invitation.email_sent_at %}
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Email Sent:</span>
                                    <span class="text-sm text-gray-900">{{ invitation.email_sent_at|date:"F j, Y \a\t g:i A" }}</span>
                                </div>
                            {% endif %}
                            {% if invitation.viewed_at %}
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">First Viewed:</span>
                                    <span class="text-sm text-gray-900">{{ invitation.viewed_at|date:"F j, Y \a\t g:i A" }}</span>
                                </div>
                            {% endif %}
                            {% if invitation.accepted_at %}
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Accepted:</span>
                                    <span class="text-sm text-green-900">{{ invitation.accepted_at|date:"F j, Y \a\t g:i A" }}</span>
                                </div>
                            {% endif %}
                            {% if invitation.declined_at %}
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Declined:</span>
                                    <span class="text-sm text-red-900">{{ invitation.declined_at|date:"F j, Y \a\t g:i A" }}</span>
                                </div>
                            {% endif %}
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Expires:</span>
                                <span class="text-sm {% if invitation.is_expired %}text-red-900{% else %}text-gray-900{% endif %}">
                                    {{ invitation.expires_at|date:"F j, Y \a\t g:i A" }}
                                    {% if invitation.is_expired %}<span class="ml-2 text-red-600">(Expired)</span>{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Message -->
                    {% if invitation.custom_message %}
                        <div class="pt-6 border-t border-gray-200">
                            <h4 class="text-sm font-medium text-gray-500 mb-2">Personal Message</h4>
                            <div class="bg-gray-50 rounded-md p-4">
                                <p class="text-sm text-gray-900">{{ invitation.custom_message|linebreaks }}</p>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Email Delivery Info -->
                    {% if invitation.email_delivery_status != 'not_sent' %}
                        <div class="pt-6 border-t border-gray-200">
                            <h4 class="text-sm font-medium text-gray-500 mb-4">Email Delivery</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Delivery Status:</span>
                                    <span class="text-sm 
                                        {% if invitation.email_delivery_status == 'delivered' %}text-green-900
                                        {% elif invitation.email_delivery_status == 'failed' %}text-red-900
                                        {% else %}text-gray-900{% endif %}">
                                        {{ invitation.get_email_delivery_status_display }}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Retry Count:</span>
                                    <span class="text-sm text-gray-900">{{ invitation.retry_count }}/{{ invitation.max_retries }}</span>
                                </div>
                                {% if invitation.email_failure_reason %}
                                    <div>
                                        <span class="text-sm text-gray-600">Last Failure Reason:</span>
                                        <p class="text-sm text-red-900 mt-1">{{ invitation.email_failure_reason }}</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Action Buttons -->
                <div class="pt-6 border-t border-gray-200 flex justify-end space-x-3">
                    <a href="{% url 'accounts:invitation_list' %}" 
                       class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                        Back to List
                    </a>
                    
                    {% if invitation.is_valid and invitation.can_retry %}
                        <button hx-post="{% url 'accounts:resend_invitation' invitation.pk %}"
                                hx-target="#invitation-detail"
                                hx-swap="innerHTML"
                                class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition-colors">
                            <i class="fas fa-paper-plane mr-2"></i>Resend Invitation
                        </button>
                    {% endif %}
                    
                    {% if invitation.is_valid %}
                        <button hx-post="{% url 'accounts:cancel_invitation' invitation.pk %}"
                                hx-confirm="Are you sure you want to cancel this invitation?"
                                hx-target="#invitation-detail"
                                hx-swap="innerHTML"
                                class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition-colors">
                            <i class="fas fa-ban mr-2"></i>Cancel Invitation
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}