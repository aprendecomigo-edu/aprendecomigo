<!-- Consolidated Sign-In Form - Email Input and Delivery Choice on Same Page -->
<div class="w-full space-y-8" x-data="{ email: '{{ email|default:'' }}' }">
    <!-- Email Input Field -->
    <div class="form-control">
        <label class="label">
            <span class="label-text font-primary font-medium">Email address</span>
        </label>
        <div class="relative">
            <label class="input validator glass-light w-full">
                <input type="email"
                       x-model="email"
                       placeholder="your_email@example.com"
                       pattern="^[^\s@]+@[^\s@]+\.[^\s@]+$"
                       title="Must be a valid email address"
                       autocomplete="email"
                       required />
            </label>
            <div class="validator-hint">
                Must be a valid email address
            </div>

            <!-- Server-side error message -->
            {% if error %}
            <div class="validator-hint text-error">
                {{ error }}
            </div>
            {% endif %}

            <!-- Resend verification button for unverified users -->
            {% if show_resend_verification %}
            <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                <div class="text-sm text-amber-800 mb-3">
                    Need to verify your email? We can send you a new verification link.
                </div>
                <div id="resend-verification-message"></div>
                <form hx-post="{% url 'accounts:resend_verification_email_signin' %}"
                      hx-target="#resend-verification-message"
                      hx-swap="innerHTML"
                      class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="email" x-bind:value="email" />
                    <button type="submit"
                            class="btn btn-sm btn-outline btn-amber htmx-request:opacity-50 htmx-request:pointer-events-none">
                        <span class="htmx-indicator loading loading-spinner loading-xs opacity-0"></span>
                        Resend Verification Email
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Delivery Method Options -->
    <div class="space-y-4">
        <div class="text-center">
            <span class="label-text font-primary font-medium">Choose how to receive your sign-in code:</span>
        </div>

        <!-- Email Option -->
        <form hx-post="{% url 'accounts:send_otp_email' %}"
              hx-target="#signin-form-container"
              hx-swap="innerHTML"
              class="w-full">
            {% csrf_token %}
            <input type="hidden" name="email" x-bind:value="email" />
            <button type="submit"
                    class="btn btn-primary w-full bg-gradient-primary glass-light htmx-request:opacity-50 htmx-request:pointer-events-none"
                    x-bind:disabled="!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)">
                <span class="htmx-indicator loading loading-spinner loading-sm opacity-0"></span>
                Send Code via Email
            </button>
        </form>

        <!-- SMS Option - conditionally shown based on waffle flag -->
        {% if sms_enabled %}
        <form hx-post="{% url 'accounts:send_otp_sms' %}"
              hx-target="#signin-form-container"
              hx-swap="innerHTML"
              class="w-full">
            {% csrf_token %}
            <input type="hidden" name="email" x-bind:value="email" />
            <button type="submit"
                    class="btn btn-secondary w-full glass-light htmx-request:opacity-50 htmx-request:pointer-events-none"
                    x-bind:disabled="!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)">
                <span class="htmx-indicator loading loading-spinner loading-sm opacity-0"></span>
                Send Code via SMS
            </button>
        </form>
        {% endif %}
    </div>
</div>
