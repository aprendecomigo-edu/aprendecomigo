<!-- Combined Success Message + Verification Form -->
<div class="w-full space-y-6 text-center">
    <!-- Success icon and message -->
    <div class="flex justify-center">
        <div class="w-16 h-16 bg-success/10 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-success" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
        </div>
    </div>

    <!-- Success message -->
    <div class="space-y-2 mb-6">
        <h3 class="card-title color-primary font-primary text-2xl font-bold justify-center">Code Sent!</h3>
        <p class="text-base-content/70 font-body">
            We've sent verification codes to your email and phone<br>
            <span class="font-medium text-base-content">{{ email }}</span>
        </p>
    </div>

    <!-- Verification Form -->
    <form {% if not session_expired %}hx-post="{% url 'accounts:verify_otp' %}"
          hx-target="#signin-form-container"
          hx-swap="innerHTML"{% endif %}
          class="w-full space-y-6"{% if session_expired %} style="pointer-events: none; opacity: 0.6;"{% endif %}>
        {% csrf_token %}

        <!-- Verification Code Field with 6 Separate Inputs -->
        <div class="w-full">
            <label class="block mb-4 text-center">
                <span class="font-primary font-medium text-gray-700">Enter the 6-digit code</span>
            </label>

            <div class="relative">
                <!-- 6 Individual Input Fields -->
                <div class="flex justify-center gap-3 mb-4" id="otp-inputs">
                    <input type="text"
                           class="otp-input w-12 h-12 text-center text-xl font-mono border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors"
                           maxlength="1"
                           inputmode="numeric"
                           pattern="[0-9]"
                           data-index="0"
                           autofocus />
                    <input type="text"
                           class="otp-input w-12 h-12 text-center text-xl font-mono border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors"
                           maxlength="1"
                           inputmode="numeric"
                           pattern="[0-9]"
                           data-index="1" />
                    <input type="text"
                           class="otp-input w-12 h-12 text-center text-xl font-mono border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors"
                           maxlength="1"
                           inputmode="numeric"
                           pattern="[0-9]"
                           data-index="2" />
                    <input type="text"
                           class="otp-input w-12 h-12 text-center text-xl font-mono border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors"
                           maxlength="1"
                           inputmode="numeric"
                           pattern="[0-9]"
                           data-index="3" />
                    <input type="text"
                           class="otp-input w-12 h-12 text-center text-xl font-mono border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors"
                           maxlength="1"
                           inputmode="numeric"
                           pattern="[0-9]"
                           data-index="4" />
                    <input type="text"
                           class="otp-input w-12 h-12 text-center text-xl font-mono border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors"
                           maxlength="1"
                           inputmode="numeric"
                           pattern="[0-9]"
                           data-index="5" />
                </div>

                <!-- Hidden input for form submission -->
                <input type="hidden" name="verification_code" id="verification-code-hidden" />

                <!-- Server-side error message -->
                {% if error %}
                <div class="flex items-center justify-center mt-2 text-red-600">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <span class="font-body text-sm">{{ error }}</span>
                </div>
                {% endif %}

                <!-- Loading Spinner Overlay -->
                <div class="htmx-indicator absolute inset-0 flex items-center justify-center bg-base-100/50 backdrop-blur-sm rounded-lg opacity-0 invisible">
                    <div class="loading loading-spinner loading-md text-primary"></div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-center mt-8">
            <div class="relative w-full max-w-sm">
                <button type="submit"
                        class="w-full bg-gradient-primary py-4 rounded-xl active:scale-98 transition-all shadow-lg text-white text-center font-bold font-primary text-base htmx-request:opacity-50 htmx-request:pointer-events-none"
                        data-test="verify-code">
                    Verify Code
                </button>

                <!-- Loading Spinner Overlay -->
                <div class="htmx-indicator absolute inset-0 flex items-center justify-center bg-base-100/50 backdrop-blur-sm rounded-lg opacity-0 invisible" data-test="loading-verify">
                    <div class="loading loading-spinner loading-md text-primary"></div>
                </div>
            </div>
        </div>

        <!-- Resend option -->
        <div class="text-center mt-4">
            {% if session_expired %}
                <p class="text-sm text-base-content/70 font-body">
                    Your session has expired.
                    <a href="{% url 'accounts:signin' %}"
                       class="link link-primary font-medium">
                        Please sign in again
                    </a>
                </p>
            {% else %}
                <p class="text-sm text-base-content/70 font-body">
                    Didn't receive the code?
                    <button type="button"
                            hx-post="{% url 'accounts:resend_code' %}"
                            hx-target="#signin-form-container"
                            class="link link-primary font-medium">
                        Resend
                    </button>
                </p>
            {% endif %}
        </div>
    </form>
</div>

<script>
    // Handle 6 separate OTP input fields - HTMX compatible version
    (function() {
        'use strict';

        // Use a unique identifier to prevent double initialization
        const INITIALIZATION_KEY = 'otp-initialized-' + Date.now();

        function initializeOtpInputs() {
            // Skip if already initialized on this page load
            if (document.body.getAttribute('data-' + INITIALIZATION_KEY)) {
                return;
            }

            const otpInputs = document.querySelectorAll('.otp-input');
            const hiddenInput = document.getElementById('verification-code-hidden');
            const form = document.querySelector('form');

            // Early return if elements not found
            if (otpInputs.length === 0 || !hiddenInput || !form) {
                console.warn('OTP initialization: Missing required elements');
                return;
            }

            console.log('OTP initialization: Found', otpInputs.length, 'inputs');

            // Mark as initialized
            document.body.setAttribute('data-' + INITIALIZATION_KEY, 'true');

            // Update hidden input with combined value
            function updateHiddenInput() {
                const currentInputs = document.querySelectorAll('.otp-input');
                const code = Array.from(currentInputs).map(input => input.value).join('');
                hiddenInput.value = code;

                console.log('OTP code updated:', code);

                // Auto-submit when all 6 digits are entered
                if (code.length === 6) {
                    console.log('Auto-submitting form with complete code');
                    form.dispatchEvent(new Event('submit'));
                }
            }

            otpInputs.forEach((input, index) => {
                console.log('Initializing OTP input', index);

                // Handle input
                input.addEventListener('input', function(e) {
                    console.log('Input event on field', index, 'value:', e.target.value);

                    // Only allow numbers
                    const sanitizedValue = e.target.value.replace(/[^0-9]/g, '');
                    if (e.target.value !== sanitizedValue) {
                        e.target.value = sanitizedValue;
                    }

                    // Move to next input if digit is entered
                    if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                        console.log('Moving focus from', index, 'to', index + 1);
                        const nextInput = otpInputs[index + 1];

                        // Small delay to ensure the current input processing is complete
                        setTimeout(() => {
                            nextInput.focus();
                            nextInput.select();
                        }, 10);
                    }

                    updateHiddenInput();
                });

                // Handle backspace
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace') {
                        // If field is empty and not the first field, move to previous
                        if (e.target.value === '' && index > 0) {
                            console.log('Backspace: moving focus from', index, 'to', index - 1);
                            setTimeout(() => {
                                otpInputs[index - 1].focus();
                                otpInputs[index - 1].select();
                            }, 10);
                        }
                        // If field has content, clear it but stay focused
                        else if (e.target.value !== '') {
                            setTimeout(() => {
                                updateHiddenInput();
                            }, 10);
                        }
                    }
                });

                // Handle paste
                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);

                    console.log('Paste event: data =', pastedData);

                    // Fill inputs with pasted digits
                    for (let i = 0; i < pastedData.length && (index + i) < otpInputs.length; i++) {
                        otpInputs[index + i].value = pastedData[i];
                    }

                    // Focus on next empty input or last input
                    const nextIndex = Math.min(index + pastedData.length, otpInputs.length - 1);
                    setTimeout(() => {
                        otpInputs[nextIndex].focus();
                        otpInputs[nextIndex].select();
                        updateHiddenInput();
                    }, 10);
                });
            });

            // Focus first input
            setTimeout(() => {
                if (otpInputs[0]) {
                    otpInputs[0].focus();
                    otpInputs[0].select();
                }
            }, 100);
        }

        // Initialize immediately (for dynamic content)
        initializeOtpInputs();

        // Also initialize after HTMX content is settled (backup)
        if (window.htmx) {
            document.addEventListener('htmx:afterSettle', function(event) {
                if (event.target.querySelector && event.target.querySelector('.otp-input')) {
                    console.log('HTMX afterSettle: Re-initializing OTP inputs');
                    // Reset initialization flag to allow re-initialization
                    document.body.removeAttribute('data-' + INITIALIZATION_KEY);
                    setTimeout(initializeOtpInputs, 50);
                }
            });
        }
    })();
</script>
