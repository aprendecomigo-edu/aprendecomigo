{% extends 'base_with_navs.html' %}
{% load static %}

{% block page_title %}Chat{% endblock %}

{% block dashboard_content %}
{% csrf_token %}

<!-- Initialize chat data -->
<script>
window.chatData = {
    currentUser: {
        id: {{ user.id }},
        username: "{{ user.username }}",
        firstName: "{{ user.first_name }}",
        lastName: "{{ user.last_name }}",
        email: "{{ user.email }}"
    },
    wsProtocol: window.location.protocol === 'https:' ? 'wss:' : 'ws:',
    wsHost: window.location.host
};

// WebSocket management (CRITICAL: Keep this for real-time functionality)
let currentWebSocket = null;

function initWebSocket(channelId, channelName) {
    if (currentWebSocket) {
        currentWebSocket.close();
    }
    
    const wsUrl = `${window.chatData.wsProtocol}//${window.chatData.wsHost}/ws/chat/${channelName}/`;
    currentWebSocket = new WebSocket(wsUrl);
    
    currentWebSocket.onopen = () => {
        console.log('WebSocket connected to channel:', channelName);
    };
    
    currentWebSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'chat_message') {
            // Append new message to chat (real-time delivery)
            appendMessageToChat(data.message);
        } else if (data.type === 'user_status') {
            handleUserStatusUpdate(data);
        }
    };
    
    currentWebSocket.onclose = () => {
        console.log('WebSocket disconnected');
    };
    
    currentWebSocket.onerror = (error) => {
        console.error('WebSocket error:', error);
    };
    
    return currentWebSocket;
}

function appendMessageToChat(messageData) {
    const messagesContainer = document.getElementById('messages-list');
    if (!messagesContainer) return;
    
    // Create message HTML (simplified - in real implementation you'd want to render properly)
    const messageHtml = `
        <div class="message-item flex items-start space-x-3">
            <div class="w-8 h-8 rounded-full flex items-center justify-center bg-gray-600">
                <span class="text-white font-medium text-sm">${messageData.sender.first_name.charAt(0).toUpperCase()}</span>
            </div>
            <div class="flex-1 max-w-3xl">
                <div class="flex items-center space-x-2 mb-1">
                    <span class="font-medium text-gray-900">${messageData.sender.first_name} ${messageData.sender.last_name}</span>
                    <span class="text-xs text-gray-500">${new Date(messageData.timestamp).toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm border">
                    <p class="text-gray-700">${messageData.content}</p>
                </div>
            </div>
        </div>
    `;
    
    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function handleUserStatusUpdate(data) {
    // Handle user online/offline status updates
    console.log('User status update:', data);
}
</script>

<!-- Slack-style Chat Interface -->
<div x-data="chatUI()" class="flex h-screen bg-gray-50">
    
    <!-- Left Sidebar - Channels and DMs -->
    <div class="w-80 bg-gray-900 text-white flex flex-col">
        
        <!-- Sidebar Header -->
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold text-white">Chat</h1>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                    <span class="text-sm text-gray-300">Online</span>
                </div>
            </div>
            <div class="text-sm text-gray-400 mt-1">{{ user.first_name }} {{ user.last_name }}</div>
        </div>

        <!-- Channels Section -->
        <div class="flex-1 overflow-y-auto">
            
            <!-- Direct Messages -->
            <div class="p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-gray-300 uppercase tracking-wide">Direct Messages</h3>
                    <button @click="showNewDMModal = true" class="text-gray-400 hover:text-white text-xs">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <!-- Server-rendered Channels List (No fetch calls) -->
                {% include 'classroom/partials/channels_list.html' %}
            </div>
        </div>

        <!-- User Info at Bottom -->
        <div class="p-4 border-t border-gray-700">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                    <span class="text-white font-medium text-sm">{{ user.first_name.0|upper|default:"A" }}</span>
                </div>
                <div class="flex-1">
                    <div class="text-white font-medium text-sm">{{ user.first_name }} {{ user.last_name }}</div>
                    <div class="text-gray-400 text-xs">{{ user.email }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        
        <!-- Chat Header -->
        {% if selected_channel %}
        <div class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">
                            {% if selected_channel.is_direct %}
                                {% for participant in selected_channel.participants.all %}
                                    {% if participant.username != user.username %}
                                        {{ participant.first_name }} {{ participant.last_name }}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {{ selected_channel.name }}
                            {% endif %}
                        </h2>
                        <div class="flex items-center text-sm text-gray-500 mt-1">
                            {% if selected_channel.is_direct %}
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-2 bg-gray-400"></div>
                                    <span>Direct Message</span>
                                </div>
                            {% else %}
                                <span>{{ selected_channel.participants.count }} members</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Welcome State (No Channel Selected) -->
        {% if not selected_channel %}
        <div class="flex-1 flex items-center justify-center bg-gray-50">
            <div class="text-center">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Welcome to Chat</h3>
                <p class="text-gray-500 mb-4">Select a conversation to start messaging</p>
                <button @click="showNewDMModal = true" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Start New Conversation
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Messages Area -->
        {% if selected_channel %}
        <div id="messages-container">
            {% include 'classroom/partials/messages_list.html' %}
        </div>

        <!-- Message Input with HTMX -->
        <div class="border-t border-gray-200 p-4 bg-white">
            <form hx-post="{% url 'chat' %}"
                  hx-target="#messages-list"
                  hx-swap="beforeend"
                  @htmx:after-request="messageInput = ''"
                  class="flex items-center space-x-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="send_message">
                <input type="hidden" name="channel_id" value="{{ selected_channel.id }}">
                
                <div class="flex-1">
                    <div class="relative">
                        <input type="text" 
                               name="content"
                               x-model="messageInput"
                               placeholder="Type your message..."
                               required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <button type="submit" 
                        :disabled="!messageInput.trim()"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium">
                    Send
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <!-- New DM Modal -->
    <div x-show="showNewDMModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4"
             @click.away="showNewDMModal = false">
            <h3 class="text-lg font-semibold mb-4">Start New Conversation</h3>
            
            <!-- User Search with HTMX -->
            <div class="mb-4">
                <input type="text"
                       x-model="userSearchQuery"
                       hx-post="{% url 'chat' %}"
                       hx-target="#search-results"
                       hx-swap="innerHTML"
                       hx-trigger="keyup changed delay:300ms"
                       hx-vals='{"action": "search_users"}'
                       name="search"
                       placeholder="Search users by name or email..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                {% csrf_token %}
            </div>

            <!-- Search Results -->
            <div class="mb-4">
                {% include 'classroom/partials/user_search_results.html' with search_results='' query='' %}
            </div>

            <!-- Modal Actions -->
            <div class="flex justify-end space-x-3">
                <button @click="showNewDMModal = false; userSearchQuery = ''" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function chatUI() {
    return {
        messageInput: '',
        showNewDMModal: false,
        userSearchQuery: '',
        
        init() {
            // Initialize WebSocket for selected channel on page load
            {% if selected_channel %}
                initWebSocket({{ selected_channel.id }}, '{{ selected_channel.name }}');
            {% endif %}
            
            // Scroll to bottom of messages on load
            this.$nextTick(() => {
                this.scrollToBottom();
            });
        },
        
        switchChannel(channelId, channelName) {
            // Reconnect WebSocket for new channel
            initWebSocket(channelId, channelName);
            
            // Scroll to bottom after switching
            this.$nextTick(() => {
                this.scrollToBottom();
            });
        },
        
        scrollToBottom() {
            const container = document.getElementById('messages-list');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chat interface loaded with HTMX and WebSocket');
    
    // Auto-scroll messages container after HTMX swaps
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.target.id === 'messages-list' || event.target.closest('#messages-list')) {
            const container = document.getElementById('messages-list');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
    });
});
</script>
{% endblock %}